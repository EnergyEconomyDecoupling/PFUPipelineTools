% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/retrieving.R
\name{pl_filter_collect}
\alias{pl_filter_collect}
\title{Filter a table from the database using natural expressions}
\usage{
pl_filter_collect(
  db_table_name,
  datasets = NULL,
  versions = NULL,
  countries = NULL,
  years = NULL,
  methods = NULL,
  last_stages = NULL,
  energy_types = NULL,
  gross_nets = NULL,
  includes_neu = NULL,
  industry_aggs = NULL,
  product_aggs = NULL,
  chopped_mats = NULL,
  chopped_vars = NULL,
  collect = FALSE,
  conn,
  schema = schema_from_conn(conn = conn),
  fk_parent_tables = get_all_fk_tables(conn = conn, schema = schema),
  index_map_name = "Index",
  index_map = fk_parent_tables[[index_map_name]],
  rctype_table_name = "matnameRCType",
  rctypes = decode_fks(db_table_name = rctype_table_name, collect = TRUE, conn = conn,
    schema = schema, fk_parent_tables = fk_parent_tables),
  matrix_class = c("Matrix", "matrix"),
  matname = "matname",
  matval = "matval",
  rowtype_colname = "rowtype",
  coltype_colname = "coltype",
  country_colname = IEATools::iea_cols$country,
  year_colname = IEATools::iea_cols$year,
  method_colname = IEATools::iea_cols$method,
  last_stage_colname = IEATools::iea_cols$last_stage,
  energy_type_colname = IEATools::iea_cols$energy_type,
  gross_net_colname = Recca::efficiency_cols$gross_net,
  dataset_colname = PFUPipelineTools::dataset_info$dataset_colname,
  includes_neu_colname = Recca::psut_cols$includes_neu,
  product_agg_colname = PFUPipelineTools::aggregation_df_cols$product_aggregation,
  industry_agg_colname = PFUPipelineTools::aggregation_df_cols$industry_aggregation,
  chopped_mat_colname = PFUPipelineTools::aggregation_df_cols$chopped_mat,
  chopped_var_colname = PFUPipelineTools::aggregation_df_cols$chopped_var
)
}
\arguments{
\item{db_table_name}{The string name of the database table to be filtered.}

\item{datasets}{A vector of dataset strings to be retained in the output.
\code{NULL} (the default) returns all datasets.
Another interesting option is
\code{PFUPipelineTools::dataset_info$clpfu_iea}.}

\item{versions}{A string vector indicating the versions to be downloaded.
\code{NULL}, the default, means to download all versions available in the table.}

\item{countries}{A vector of country strings to be retained in the output.
\code{NULL} (the default) returns all countries.
Another useful option is \code{as.character(PFUPipelineTools::canonical_countries)}.}

\item{years}{A vector of integers to be retained in the output.
\code{NULL} (the default) returns all years.
Another option is \code{1960:2020}.}

\item{methods}{A vector of method strings to be retained in the output.
\code{NULL} (the default) returns all methods.
Another good option is "PCM" (physical content method).}

\item{last_stages}{A vector of last stage strings to be retained in the output.
At present, only "Final" and "Useful" are implemented.
\code{NULL} (the default) returns all last stages.}

\item{energy_types}{A vector of energy type strings to be retained in the output.
At present, only "E" (energy) and "X" (exergy) are implemented.
\code{NULL} (the default) returns all energy types.}

\item{gross_nets}{A vector of values for the \code{GrossNet} column (when it exists).
\code{NULL} (the default) turns off filtering on this column.
Other good values are "Gross" and "Net".}

\item{includes_neu}{A vector of booleans that indicates what to retain in output.
\code{TRUE} means non-energy use is included in the ECCs.
\code{FALSE} means non-energy use is excluded from the ECCs.
Default is \code{NULL}, meaning extract both \code{TRUE} and `FALSE values.}

\item{industry_aggs}{A vector of strings identifying the industry aggregations desired.
\code{NULL} (the default) means all industry aggregations should be returned.
Other reasonable values are "Specified", "Despecified", and "Grouped".}

\item{product_aggs}{A vector of strings identifying the product aggregations desired.
\code{NULL} (the default) means all product aggregations should be returned.
Other reasonable values are "Specified", "Despecified", and "Grouped".}

\item{chopped_mats}{A vector of strings identifying the matrix chops desired.
\code{NULL} (the default) means all chopped matrices should be returned.}

\item{chopped_vars}{A vector of strings identifying the matrix variables desired.
\code{NULL} (the default) means all chopped variables should be returned.}

\item{collect}{A boolean that tells whether to download the result.
Default is \code{FALSE}.
See details.}

\item{conn}{The database connection.}

\item{schema}{The data model (\code{dm} object) for the database in \code{conn}.
Default is \code{schema_from_conn(conn = conn)}.
See details.}

\item{fk_parent_tables}{A named list of all parent tables
for the foreign keys in \code{db_table_name}.
Default is
\code{get_all_fk_tables(conn = conn, schema = schema)}.
See details.}

\item{index_map_name}{The name of the table that serves as the index for row and column names.
Default is "Index".}

\item{index_map}{The index map for the matrices in the database at \code{conn}.
Default is \code{fk_parent_tables[[index_table_name]]}.}

\item{rctype_table_name}{The name of the table that contains row and column types.
Default is "matnameRCType".}

\item{rctypes}{The table of row and column types for the database at \code{conn}.
Default is \code{fk_parent_tables[[rctype_table_name]]}.}

\item{matrix_class}{One of "Matrix" (the default) for sparse matrices or
"matrix" (the base matrix representation in \code{R}) for non-sparse matrices.}

\item{matname}{The name of the matrix name column.
Default is "matname".}

\item{matval}{The name of the matrix value column.
Default is "matval".}

\item{rowtype_colname, coltype_colname}{The names for row and column type columns in data frames.
Defaults are "rowtype" and "coltype", respectively.}

\item{dataset_colname, country_colname, year_colname, method_colname, last_stage_colname, energy_type_colname, gross_net_colname, product_agg_colname, industry_agg_colname, chopped_mat_colname, chopped_var_colname}{Columns that are likely to be in db_table_name
and may be filtered with \code{\%in\%}-style subsetting.}

\item{includes_neu_col}{The name of a column that tells whether non-energy
use (NEU) is included.
Default is \code{Recca::psut_cols$includes_neu}.}
}
\value{
A filtered version of \code{db_table_name} downloaded from \code{conn}.
}
\description{
Often when collecting data from the database,
filtering is desired.
But filtering based on foreign keys (as stored in the database)
is effectively impossible, because of foreign key encoding.
This function filters based on
fk values (typically strings),
not fk keys (typically integers),
thereby simplifying the filtering process,
with optional downloading thereafter.
By default, a \code{tbl} is returned
(and data are not downloaded from the database).
Use \code{dplyr::collect()} to execute the resulting SQL query
and obtain an in-memory data frame.
Or, set \code{collect = TRUE} to execute the SQL and
return an in-memory data frame.
}
\details{
To obtain \code{db_table_name} \emph{without} filtering
but with fk keys (typically integers)
decoded to fk values (typically strings),
call this function with nothing in the \code{...} argument.

\code{schema} is a data model (\code{dm} object) for the CL-PFU database.
It can be obtained from calling \code{schema_from_conn()}.
If minimal interaction with the database is desired,
be sure to override the default value for \code{schema}
by supplying a pre-computed \code{dm} object.

\code{fk_parent_tables} is a named list of tables,
some of which are fk parent tables containing
the mapping between fk values (usually strings)
and fk keys (usually integers)
for \code{db_table_name}.
\code{fk_parent_tables} is treated as a store from which foreign key tables
are retrieved by name when needed.
An appropriate value for \code{fk_parent_tables} can be obtained
from \code{get_all_fk_tables()}.
If minimal interaction with the database is desired,
be sure to override the default value for \code{fk_parent_tables}
by supplying a pre-computed named list of
foreign key tables.

Setting any of the filtering arguments
(\code{countries}, \code{years}, \code{methods}, \code{last_stages}, \code{energy_types}, \code{includes_neu})
to \code{NULL} turns off filtering and returns all values.

When \code{collect = TRUE},
\code{\link[=decode_matsindf]{decode_matsindf()}} is called on the downloaded data frame.
}
