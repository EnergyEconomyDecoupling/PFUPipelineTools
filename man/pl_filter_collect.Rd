% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/retrieving.R
\name{pl_filter_collect}
\alias{pl_filter_collect}
\title{Filter a table from the database using natural expressions}
\usage{
pl_filter_collect(
  db_table_name,
  countries = NULL,
  years = NULL,
  methods = NULL,
  last_stages = NULL,
  energy_types = NULL,
  country = IEATools::iea_cols$country,
  year = IEATools::iea_cols$year,
  method = IEATools::iea_cols$method,
  last_stage = IEATools::iea_cols$last_stage,
  energy_type = IEATools::iea_cols$energy_type,
  conn,
  collect = FALSE,
  schema = schema_from_conn(conn = conn),
  fk_parent_tables = get_all_fk_tables(conn = conn, schema = schema)
)
}
\arguments{
\item{db_table_name}{The string name of the database table to be filtered.}

\item{countries, years, methods, last_stages, energy_types}{Vectors of strings to be kept from
the respective columns.
Default values are \code{NULL}, meaning
that no filters should be applied.}

\item{country, year, method, last_stage, energy_type}{Columns that are likely to be in db_table_name
and may be filtered with \code{\%in\%}-style subsetting.}

\item{conn}{The database connection.}

\item{collect}{A boolean that tells whether to download the result.
Default is \code{FALSE}.
See details.}

\item{schema}{The data model (\code{dm} object) for the database in \code{conn}.
Default is \code{schema_from_conn(conn = conn)}.
See details.}

\item{fk_parent_tables}{A named list of all parent tables
for the foreign keys in \code{db_table_name}.
Default is
\code{get_all_fk_tables(conn = conn, schema = schema)}.
See details.}
}
\value{
A data frame downloaded from \code{conn},
a filtered version of \code{db_table_name}.
}
\description{
Often when collecting data from the database,
filtering is desired.
But filtering based on foreign keys (as stored in the database)
is effectively impossible, because of foreign key encoding.
This function filters based on
fk values (typically strings),
not fk keys (typically integers),
thereby simplifying the filtering process,
with optional downloading thereafter.
By default, a \code{tbl} is returned
(and data are not downloaded from the database).
Use \code{dplyr::collect()} to execute the resulting SQL query
and obtain an in-memory data frame.
Or, set \code{collect = TRUE} to execute the SQL and
return an in-memory data frame.
}
\details{
To obtain \code{db_table_name} \emph{without} filtering
but with fk keys (typically integers)
decoded to fk values (typically strings),
call this function with nothing in the \code{...} argument.

\code{schema} is a data model (\code{dm} object) for the CL-PFU database.
It can be obtained from calling \code{schema_from_conn()}.
If minimal interaction with the database is desired,
be sure to override the default value for \code{schema}
by supplying a pre-computed \code{dm} object.

\code{fk_parent_tables} is a named list of tables,
some of which are fk parent tables containing
the mapping between fk values (usually strings)
and fk keys (usually integers)
for \code{db_table_name}.
\code{fk_parent_tables} is treated as a store from which foreign key tables
are retrieved by name when needed.
An appropriate value for \code{fk_parent_tables} can be obtained
from \code{get_all_fk_tables()}.
If minimal interaction with the database is desired,
be sure to override the default value for \code{fk_parent_tables}
by supplying a pre-computed named list of
foreign key tables.
}
