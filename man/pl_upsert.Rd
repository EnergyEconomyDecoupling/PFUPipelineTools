% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/schema.R
\name{pl_upsert}
\alias{pl_upsert}
\title{Upsert a data frame with optional recoding of foreign keys}
\usage{
pl_upsert(
  .df,
  conn,
  db_table_name = NULL,
  additional_hash_group_cols = NULL,
  usual_hash_group_cols = PFUPipelineTools::usual_hash_group_cols,
  keep_single_unique_cols = TRUE,
  in_place = FALSE,
  encode_fks = TRUE,
  compress = FALSE,
  index_map =
    magrittr::set_names(list(fk_parent_tables[[IEATools::row_col_types$industry]],
    fk_parent_tables[[IEATools::row_col_types$product]],
    fk_parent_tables[[IEATools::row_col_types$other]]),
    c(IEATools::row_col_types$industry, IEATools::row_col_types$product,
    IEATools::row_col_types$other)),
  retain_zero_structure = FALSE,
  schema = schema_from_conn(conn),
  fk_parent_tables = get_all_fk_tables(conn = conn, schema = schema, collect = TRUE),
  .db_table_name = PFUPipelineTools::hashed_table_colnames$db_table_name,
  .pk_col = PFUPipelineTools::dm_pk_colnames$pk_col,
  .algo = "md5"
)
}
\arguments{
\item{.df}{The data frame to be upserted.}

\item{conn}{A connection to the CL-PFU database.}

\item{db_table_name}{A string identifying the destination for \code{.df} in \code{conn},
i.e. the name of a remote database table.
Default is \code{NULL}, meaning that the value for this argument
will be taken from the \code{.db_table_name} column of \code{.df}.}

\item{additional_hash_group_cols}{A vector or list of additional columns
by which \code{.df} will be grouped
before hashing and, therefore, appear in the output.
Default is \code{NULL}.
Passed to \code{\link[=pl_hash]{pl_hash()}}.}

\item{usual_hash_group_cols}{A vector of columns by which \code{.df} will be grouped
before hashing and, therefore, appear in the output.
Default is \code{PFUPipelineTools::additional_hash_group_cols}
but can be set to \code{NULL} to disable.
Passed to \code{\link[=pl_hash]{pl_hash()}}.}

\item{keep_single_unique_cols}{A boolean that tells whether to keep
columns with a single unique value
in the output.
Default is \code{TRUE}.
Passed to \code{\link[=pl_hash]{pl_hash()}}.}

\item{in_place}{A boolean that tells whether to modify the database at \code{conn}.
Default is \code{FALSE}, which is helpful if you want to chain
several requests.}

\item{encode_fks}{A boolean that tells whether to code foreign keys in \code{.df}
before upserting to \code{conn}.
Default is \code{TRUE}.}

\item{compress}{A boolean that tells whether to compress \code{db_table_name}
in the database after uploading.
Default is \code{FALSE}.}

\item{index_map}{A list of 2 or more data frames that represent the
mappings from inboard row and column indices in the database
to outboard row and column names in the memory
of the local computer.
See documentation for \code{\link[=encode_matsindf]{encode_matsindf()}} and
\code{\link[matsbyname:to_named_triplet]{matsbyname::to_triplet()}}.
Default is a \code{list} that contains the \code{industry}, \code{product}, and \code{other}
members of \code{fk_parent_tables}.}

\item{retain_zero_structure}{A boolean that tells whether to retain the structure
of zero matrices.
See details.}

\item{schema}{The data model (\code{dm} object) for the database in \code{conn}.
Default is \code{dm_from_con(conn, learn_keys = TRUE)}.
See details.}

\item{fk_parent_tables}{A named list of all parent tables
for the foreign keys in \code{db_table_name}.
See details.}

\item{.db_table_name}{The name of the table name column in \code{.df}.
Default is \code{PFUPipelineTools::hashed_table_colnames$db_table_name}.}

\item{.pk_col}{The name of the primary key column in a primary key table.
See \code{PFUPipelineTools::dm_pk_colnames}.}

\item{.algo}{The hashing algorithm.
Default is "md5".}
}
\value{
A hash of \code{.df} according to \code{.algo}.
}
\description{
Upserts
(inserts or updates,
depending on whether the private keys in \code{.df}
already exist in \code{db_table_name})
\code{.df} into \code{db_table_name} at \code{conn}.
}
\details{
This function decodes foreign keys (fks), when possible,
assuming that all fks are integers.
If non-integers (typically, character strings)
are provided in fk columns of \code{.df},
the non-integers will be recoded to their appropriate integer key values.

This function knows about CL-PFU database tables that contain
matrix information.
In particular, if \code{.df} contains matrices,
they are expanded into row-col-val format
before uploading.

The output of this function is a special data frame that
contains the following columns:
\itemize{
\item All single-valued columns columns in \code{.df},
columns given in \code{additional_hash_group_cols}
(default \code{NULL}), and
columns given in \code{usual_hash_group_cols}
(default \code{PFUPipelineTools::usual_hash_group_cols}).
\item Hash: A column with a hash of all non-foreign-key columns.
}

\code{schema} is a data model (\code{dm} object) for the database in \code{conn}.
Its default value (\code{schema_from_conn(conn)})
extracts the data model for the database at \code{conn} automatically.
However, if the caller already has the data model,
supplying it in the \code{schema} argument will save time.

\code{fk_parent_tables} is a named list of tables,
one of which (the one named \code{db_table_name})
contains the foreign keys for \code{db_table_name}.
\code{fk_parent_tables} is treated as a store from which foreign key tables
are retrieved by name when needed.
The default value (which calls \code{get_all_fk_tables()}
with \code{collect = TRUE} because decoding of foreign keys
is done outboard of the database)
retrieves all possible foreign key parent tables from \code{conn},
potentially a time-consuming process.
For speed, pre-compute all foreign key parent tables once
(via \code{get_all_fk_tables(collect = TRUE)})
and pass the list to the \code{fk_parent_tables} argument
of this function.

The user in \code{conn} must have write access to the database.

By default, \code{\link[=pl_upsert]{pl_upsert()}} will delete all zero entries
in matrices before upserting.
But for some countries and years,
that could result in missing matrices, such as \strong{U_EIOU}.
Set \code{retain_zero_structure = TRUE}
to preserve all entries in a zero matrix.
}
\seealso{
\code{pl_download()} for the reverse operation.
\code{pl_upload_schema_and_simple_tables()} for a way to establish the database schema.
}
