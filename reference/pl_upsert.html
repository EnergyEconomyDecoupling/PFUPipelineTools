<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Upsert a data frame with optional recoding of foreign keys — pl_upsert • PFUPipelineTools</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Upsert a data frame with optional recoding of foreign keys — pl_upsert"><meta name="description" content="Upserts
(inserts or updates,
depending on whether the private keys in .df
already exist in db_table_name)
.df into db_table_name at conn."><meta property="og:description" content="Upserts
(inserts or updates,
depending on whether the private keys in .df
already exist in db_table_name)
.df into db_table_name at conn."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PFUPipelineTools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.13</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Upsert a data frame with optional recoding of foreign keys</h1>

      <div class="d-none name"><code>pl_upsert.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Upserts
(inserts or updates,
depending on whether the private keys in <code>.df</code>
already exist in <code>db_table_name</code>)
<code>.df</code> into <code>db_table_name</code> at <code>conn</code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">pl_upsert</span><span class="op">(</span></span>
<span>  <span class="va">.df</span>,</span>
<span>  <span class="va">conn</span>,</span>
<span>  db_table_name <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  additional_hash_group_cols <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  usual_hash_group_cols <span class="op">=</span> <span class="fu">PFUPipelineTools</span><span class="fu">::</span><span class="va"><a href="usual_hash_group_cols.html">usual_hash_group_cols</a></span>,</span>
<span>  keep_single_unique_cols <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  in_place <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  encode_fks <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  compress <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  round_double_columns <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  digits <span class="op">=</span> <span class="fl">15</span>,</span>
<span>  index_map <span class="op">=</span></span>
<span>    <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">set_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fk_parent_tables</span><span class="op">[[</span><span class="fu">IEATools</span><span class="fu">::</span><span class="va"><a href="https://matthewheun.github.io/IEATools/reference/row_col_types.html" class="external-link">row_col_types</a></span><span class="op">$</span><span class="va">industry</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    <span class="va">fk_parent_tables</span><span class="op">[[</span><span class="fu">IEATools</span><span class="fu">::</span><span class="va"><a href="https://matthewheun.github.io/IEATools/reference/row_col_types.html" class="external-link">row_col_types</a></span><span class="op">$</span><span class="va">product</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    <span class="va">fk_parent_tables</span><span class="op">[[</span><span class="fu">IEATools</span><span class="fu">::</span><span class="va"><a href="https://matthewheun.github.io/IEATools/reference/row_col_types.html" class="external-link">row_col_types</a></span><span class="op">$</span><span class="va">other</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">IEATools</span><span class="fu">::</span><span class="va"><a href="https://matthewheun.github.io/IEATools/reference/row_col_types.html" class="external-link">row_col_types</a></span><span class="op">$</span><span class="va">industry</span>, <span class="fu">IEATools</span><span class="fu">::</span><span class="va"><a href="https://matthewheun.github.io/IEATools/reference/row_col_types.html" class="external-link">row_col_types</a></span><span class="op">$</span><span class="va">product</span>,</span>
<span>    <span class="fu">IEATools</span><span class="fu">::</span><span class="va"><a href="https://matthewheun.github.io/IEATools/reference/row_col_types.html" class="external-link">row_col_types</a></span><span class="op">$</span><span class="va">other</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  retain_zero_structure <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  schema <span class="op">=</span> <span class="fu"><a href="schema_from_conn.html">schema_from_conn</a></span><span class="op">(</span><span class="va">conn</span><span class="op">)</span>,</span>
<span>  fk_parent_tables <span class="op">=</span> <span class="fu"><a href="get_all_fk_tables.html">get_all_fk_tables</a></span><span class="op">(</span>conn <span class="op">=</span> <span class="va">conn</span>, schema <span class="op">=</span> <span class="va">schema</span>, collect <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  .db_table_name <span class="op">=</span> <span class="fu">PFUPipelineTools</span><span class="fu">::</span><span class="va"><a href="hashed_table_colnames.html">hashed_table_colnames</a></span><span class="op">$</span><span class="va">db_table_name</span>,</span>
<span>  .pk_col <span class="op">=</span> <span class="fu">PFUPipelineTools</span><span class="fu">::</span><span class="va"><a href="dm_pk_colnames.html">dm_pk_colnames</a></span><span class="op">$</span><span class="va">pk_col</span>,</span>
<span>  .algo <span class="op">=</span> <span class="st">"md5"</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg--df">.df<a class="anchor" aria-label="anchor" href="#arg--df"></a></dt>
<dd><p>The data frame to be upserted.</p></dd>


<dt id="arg-conn">conn<a class="anchor" aria-label="anchor" href="#arg-conn"></a></dt>
<dd><p>A connection to the CL-PFU database.</p></dd>


<dt id="arg-db-table-name">db_table_name<a class="anchor" aria-label="anchor" href="#arg-db-table-name"></a></dt>
<dd><p>A string identifying the destination for <code>.df</code> in <code>conn</code>,
i.e. the name of a remote database table.
Default is <code>NULL</code>, meaning that the value for this argument
will be taken from the <code>.db_table_name</code> column of <code>.df</code>.</p></dd>


<dt id="arg-additional-hash-group-cols">additional_hash_group_cols<a class="anchor" aria-label="anchor" href="#arg-additional-hash-group-cols"></a></dt>
<dd><p>A vector or list of additional columns
by which <code>.df</code> will be grouped
before hashing and, therefore, appear in the output.
Default is <code>NULL</code>.
Passed to <code><a href="pl_hash.html">pl_hash()</a></code>.</p></dd>


<dt id="arg-usual-hash-group-cols">usual_hash_group_cols<a class="anchor" aria-label="anchor" href="#arg-usual-hash-group-cols"></a></dt>
<dd><p>A vector of columns by which <code>.df</code> will be grouped
before hashing and, therefore, appear in the output.
Default is <code>PFUPipelineTools::additional_hash_group_cols</code>
but can be set to <code>NULL</code> to disable.
Passed to <code><a href="pl_hash.html">pl_hash()</a></code>.</p></dd>


<dt id="arg-keep-single-unique-cols">keep_single_unique_cols<a class="anchor" aria-label="anchor" href="#arg-keep-single-unique-cols"></a></dt>
<dd><p>A boolean that tells whether to keep
columns with a single unique value
in the output.
Default is <code>TRUE</code>.
Passed to <code><a href="pl_hash.html">pl_hash()</a></code>.</p></dd>


<dt id="arg-in-place">in_place<a class="anchor" aria-label="anchor" href="#arg-in-place"></a></dt>
<dd><p>A boolean that tells whether to modify the database at <code>conn</code>.
Default is <code>FALSE</code>, which is helpful if you want to chain
several requests.</p></dd>


<dt id="arg-encode-fks">encode_fks<a class="anchor" aria-label="anchor" href="#arg-encode-fks"></a></dt>
<dd><p>A boolean that tells whether to code foreign keys in <code>.df</code>
before upserting to <code>conn</code>.
Default is <code>TRUE</code>.</p></dd>


<dt id="arg-compress">compress<a class="anchor" aria-label="anchor" href="#arg-compress"></a></dt>
<dd><p>A boolean that tells whether to compress <code>db_table_name</code>
in the database after uploading.
Default is <code>FALSE</code>.</p></dd>


<dt id="arg-round-double-columns">round_double_columns<a class="anchor" aria-label="anchor" href="#arg-round-double-columns"></a></dt>
<dd><p>A boolean that tells whether to
round double-precision columns in <code>.df</code>.
Default is <code>FALSE</code>.</p></dd>


<dt id="arg-digits">digits<a class="anchor" aria-label="anchor" href="#arg-digits"></a></dt>
<dd><p>An integer that tells the number of significant digits.
<code>digits</code> has an effect only when <code>round_double_columns</code> is <code>TRUE</code>.
Default is <code>15</code>, which should
eliminate any numerical precision errors
for <code><a href="compress_rows.html">compress_rows()</a></code>.</p></dd>


<dt id="arg-index-map">index_map<a class="anchor" aria-label="anchor" href="#arg-index-map"></a></dt>
<dd><p>A list of 2 or more data frames that represent the
mappings from inboard row and column indices in the database
to outboard row and column names in the memory
of the local computer.
See documentation for <code><a href="encode_decode_matsindf.html">encode_matsindf()</a></code> and
<code><a href="https://matthewheun.github.io/matsbyname/reference/to_named_triplet.html" class="external-link">matsbyname::to_triplet()</a></code>.
Default is a <code>list</code> that contains the <code>industry</code>, <code>product</code>, and <code>other</code>
members of <code>fk_parent_tables</code>.</p></dd>


<dt id="arg-retain-zero-structure">retain_zero_structure<a class="anchor" aria-label="anchor" href="#arg-retain-zero-structure"></a></dt>
<dd><p>A boolean that tells whether to retain the structure
of zero matrices.
See details.</p></dd>


<dt id="arg-schema">schema<a class="anchor" aria-label="anchor" href="#arg-schema"></a></dt>
<dd><p>The data model (<code>dm</code> object) for the database in <code>conn</code>.
Default is <code>dm_from_con(conn, learn_keys = TRUE)</code>.
See details.</p></dd>


<dt id="arg-fk-parent-tables">fk_parent_tables<a class="anchor" aria-label="anchor" href="#arg-fk-parent-tables"></a></dt>
<dd><p>A named list of all parent tables
for the foreign keys in <code>db_table_name</code>.
See details.</p></dd>


<dt id="arg--db-table-name">.db_table_name<a class="anchor" aria-label="anchor" href="#arg--db-table-name"></a></dt>
<dd><p>The name of the table name column in <code>.df</code>.
Default is <code>PFUPipelineTools::hashed_table_colnames$db_table_name</code>.</p></dd>


<dt id="arg--pk-col">.pk_col<a class="anchor" aria-label="anchor" href="#arg--pk-col"></a></dt>
<dd><p>The name of the primary key column in a primary key table.
See <code><a href="dm_pk_colnames.html">PFUPipelineTools::dm_pk_colnames</a></code>.</p></dd>


<dt id="arg--algo">.algo<a class="anchor" aria-label="anchor" href="#arg--algo"></a></dt>
<dd><p>The hashing algorithm.
Default is "md5".</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A hash of <code>.df</code> according to <code>.algo</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function decodes foreign keys (fks), when possible,
assuming that all fks are integers.
If non-integers (typically, character strings)
are provided in fk columns of <code>.df</code>,
the non-integers will be recoded to their appropriate integer key values.</p>
<p>This function knows about CL-PFU database tables that contain
matrix information.
In particular, if <code>.df</code> contains matrices,
they are expanded into row-col-val format
before uploading.</p>
<p>The output of this function is a special data frame that
contains the following columns:</p><ul><li><p>All single-valued columns columns in <code>.df</code>,
columns given in <code>additional_hash_group_cols</code>
(default <code>NULL</code>), and
columns given in <code>usual_hash_group_cols</code>
(default <code><a href="usual_hash_group_cols.html">PFUPipelineTools::usual_hash_group_cols</a></code>).</p></li>
<li><p>Hash: A column with a hash of all non-foreign-key columns.</p></li>
</ul><p><code>schema</code> is a data model (<code>dm</code> object) for the database in <code>conn</code>.
Its default value (<code>schema_from_conn(conn)</code>)
extracts the data model for the database at <code>conn</code> automatically.
However, if the caller already has the data model,
supplying it in the <code>schema</code> argument will save time.</p>
<p><code>fk_parent_tables</code> is a named list of tables,
one of which (the one named <code>db_table_name</code>)
contains the foreign keys for <code>db_table_name</code>.
<code>fk_parent_tables</code> is treated as a store from which foreign key tables
are retrieved by name when needed.
The default value (which calls <code><a href="get_all_fk_tables.html">get_all_fk_tables()</a></code>
with <code>collect = TRUE</code> because decoding of foreign keys
is done outboard of the database)
retrieves all possible foreign key parent tables from <code>conn</code>,
potentially a time-consuming process.
For speed, pre-compute all foreign key parent tables once
(via <code>get_all_fk_tables(collect = TRUE)</code>)
and pass the list to the <code>fk_parent_tables</code> argument
of this function.</p>
<p>The user in <code>conn</code> must have write access to the database.</p>
<p>By default, <code>pl_upsert()</code> will delete all zero entries
in matrices before upserting.
But for some countries and years,
that could result in missing matrices, such as <strong>U_EIOU</strong>.
Set <code>retain_zero_structure = TRUE</code>
to preserve all entries in a zero matrix.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code>pl_download()</code> for the reverse operation.
<code><a href="pl_upload_schema_and_simple_tables.html">pl_upload_schema_and_simple_tables()</a></code> for a way to establish the database schema.</p></div>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matthew Heun.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer></div>





  </body></html>

